import importlib
from perfis import buscar_perfil, perfis_z90, perfis_z45, perfis_z
from calculos_solicitante.calculos_solicitante import calcular_solicitante


def main():
    print("\nüìå Perfis dispon√≠veis para sele√ß√£o:")
    perfis_disponiveis = [
        "Z90 150x60x20x2.00", "Z90 150x60x20x4.75",
        "Z90 200x75x20x2.00", "Z90 200x75x30x6.30",
        "Z90 250x85x25x2.00", "Z90 250x85x25x4.75",
        "Z90 300x85x25x2.00", "Z90 300x85x30x6.30",
        "Z45 150x60x20x2.00", "Z45 150x60x20x4.75",
        "Z45 200x75x20x2.00", "Z45 200x75x30x6.30",
        "Z45 250x85x25x2.00", "Z45 250x85x25x4.75",
        "Z45 300x85x25x2.00", "Z45 300x85x30x6.30"
    ]

    for perfil in perfis_disponiveis:
        print(f"   - {perfil}")

    # Solicitar perfil ao usu√°rio
    nome_perfil_completo = input("\nDigite o nome exato do perfil desejado: ").strip()
    tipo, nome_perfil = nome_perfil_completo.split(" ", 1)

    if tipo == "Z90":
        lista_perfis = perfis_z90
    elif tipo == "Z45":
        lista_perfis = perfis_z45
    elif tipo == "Z":
        lista_perfis = perfis_z
    else:
        print("‚ùå Tipo de perfil n√£o reconhecido. Apenas Z90 e Z45 est√£o dispon√≠veis.")
        return

    perfil_escolhido = buscar_perfil(nome_perfil, lista_perfis)
    if not perfil_escolhido:
        print("‚ùå Perfil n√£o encontrado. Verifique a digita√ß√£o e tente novamente.")
        return

    print(f"\n‚úÖ Perfil selecionado: {tipo} {nome_perfil}")

    # Entrada da tens√£o de trabalho (fy)
    while True:
        try:
            fy = float(input("\nQual a tens√£o de trabalho (fy) em kN/cm¬≤? "))
            break
        except ValueError:
            print("‚ùå Entrada inv√°lida! Digite um n√∫mero v√°lido.")

    # Entrada de Lx, Ly, Lz, Cb
    while True:
        try:
            Lx = float(input("\nQual a dist√¢ncia entre as tesouras de cobertura (em cm)? "))
            Lz = Lx    #avaliar
            dist_ter√ßas = float(input("Qual a dist√¢ncia entre as ter√ßas em cm? "))  
            ang = float(input("Qual a inclina√ß√£o da cobertura em graus? "))
            tirantes = float(input("\nQuantos tirantes existem entre as tesouras (m√°x.:3)? ")) 
            if tirantes != 0:
                dim_tirante= float(input(" -Qual √© o di√¢metro dos tirantes em mm? "))  
            else:
                dim_tirante = 0  
            Ly = float(Lx / (tirantes + 1))                                                                 
            Cb = float(input("\nQual o coeficiente Cb da viga? "))
            break
        except ValueError:
            print("‚ùå Entrada inv√°lida! Digite um n√∫mero v√°lido.")

    # Entrada do carregamento caracter√≠stico                                        melhorar
    while True:
        try:
            metodo = input("\nDeseja realizar a an√°lise como viga bi-apoiada ou viga cont√≠nua em dois v√£os? ")
            print("\nUtilizar sinal de negativo para esforlos de compress√£o e positivo para esfor√ßos de tra√ß√£o.")
            q_p_ter√ßa= perfil_escolhido["m"] / 100 #J√° em kN/m; Futuramente ser√° trocado e vinculado aos perfis.py
            q_p_chapa= float(input(" -Qual √© o peso pr√≥prio da chapa zincada em kg/m¬≤? ")) / 100 #J√° em kN/m¬≤
            q_v = float(input(" -Qual √© a carga de vento sobre a ter√ßa em kN/m¬≤? "))           #padronizar
                
            # C√°lculo dos momentos solicitantes
            Msd_x, Msd_y = calcular_solicitante(metodo, tirantes, Lx , Ly , dist_ter√ßas , ang, q_p_ter√ßa, q_p_chapa, dim_tirante, q_v)

            print("\nüìê Momentos solicitantes m√°ximos:")
            print(f"   - Msd_x = {Msd_x:.3f} kN¬∑cm")
            print(f"   - Msd_y = {Msd_y:.3f} kN¬∑cm")

            break
        except ValueError:
            print("‚ùå Entrada inv√°lida! Digite um n√∫mero v√°lido.")

    # Importa e executa os c√°lculos corretos com base no tipo
    try:
        modulo = importlib.import_module(f"calculos_{tipo}.executar_calculos")
        resultados = modulo.executar_calculos(perfil_escolhido, fy, Lx, Ly, Lz, Cb)

        print("\nüìä Resultados dos esfor√ßos resistentes:")
        for chave, valor in resultados.items():
            print(f"   - {chave}: {valor:.3f} kN¬∑cm")

        print("\nüîé Verifica√ß√£o dos esfor√ßos resistentes:")
        for chave, valor in resultados.items():
            if "Mrd_x" in chave:
                metodo_x = chave.replace("Mrd_x_", "")
                status = "‚ùå N√£o passou!" if abs(valor) < abs(Msd_x) else "‚úÖ OK!"
                print(f"{status} ‚Üí Mrd_x_{metodo_x} = {valor:.2f} vs Msd_x = {Msd_x:.2f}")
            if "Mrd_y" in chave:
                metodo_y = chave.replace("Mrd_y_", "")
                status = "‚ùå N√£o passou!" if abs(valor) < abs(Msd_y) else "‚úÖ OK!"
                print(f"{status} ‚Üí Mrd_y_{metodo_y} = {valor:.2f} vs Msd_y = {Msd_y:.2f}")


    except ModuleNotFoundError:
        print(f"‚ùå M√≥dulo de c√°lculo para perfis {tipo} ainda n√£o est√° dispon√≠vel.")
    except Exception as e:
        print(f"‚ö†Ô∏è Erro durante os c√°lculos: {e}")

if __name__ == "__main__":
    main()
